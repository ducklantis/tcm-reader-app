<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <title>中醫醫案閱讀器 (離線版)</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- 引入 Tailwind CSS, React, 和 Babel (用於 JSX 轉換) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* 確保整個應用程式高度充滿螢幕，適合 PWA/手機使用 */
    html, body, #root {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
  </style>

</head>
<body>
  <div id="root"></div>

  <!-- 啟動 React 應用程式 (使用 Babel 轉換 JSX) -->
  <script type="text/babel">
import React, { useState, useEffect, useRef } from 'react';
import { 
  BookOpen, 
  Search, 
  Settings, 
  Shuffle, 
  FileText, 
  ChevronLeft, 
  ChevronRight, 
  Trash2, 
  Copy, 
  Moon, 
  Sun, 
  Upload, 
  Download,
  Plus,
  Edit3,
  Check,
  AlertCircle,
  X,
  Sparkles,
  MessageSquare,
  Activity,
  Key
} from 'lucide-react';

// --- 初始資料 ---
const INITIAL_CASES = [
  { id: '1', title: '範例：感冒案', content: '患者：張某\n主訴：惡風寒，汗出，頭痛，鼻鳴乾嘔。\n診斷：太陽病中風證。\n處方：桂枝湯。\n(這是範例，請嘗試匯入功能)', date: '2023-01-10' },
];

function App() {
  // --- 狀態管理 ---
  const [activeTab, setActiveTab] = useState('cases');
  const [cases, setCases] = useState(() => {
    try { const saved = localStorage.getItem('tcm_cases'); return saved ? JSON.parse(saved) : INITIAL_CASES; } catch(e) { return INITIAL_CASES; }
  });
  const [notes, setNotes] = useState(() => {
    try { const saved = localStorage.getItem('tcm_notes'); return saved ? JSON.parse(saved) : []; } catch(e) { return []; }
  });
  // API Key 儲存
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
  
  const [darkMode, setDarkMode] = useState(false);
  const [fontSize, setFontSize] = useState(20); // 預設字體調大到 20px
  
  const [viewMode, setViewMode] = useState('list');
  const [currentId, setCurrentId] = useState(null);
  const [navigationQueue, setNavigationQueue] = useState([]); 
  const [contextSource, setContextSource] = useState('database'); 

  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);

  const [isEditing, setIsEditing] = useState(false);
  const [editBuffer, setEditBuffer] = useState({}); 
  
  const [notification, setNotification] = useState(null);
  const [modalConfig, setModalConfig] = useState(null); 
  
  const [pendingFile, setPendingFile] = useState(null);
  const [separatorInput, setSeparatorInput] = useState('===');
  const fileInputRef = useRef(null);

  // AI 相關狀態
  const [aiLoading, setAiLoading] = useState(false);
  const [aiResponse, setAiResponse] = useState('');

  // --- Effects ---
  useEffect(() => { localStorage.setItem('tcm_cases', JSON.stringify(cases)); }, [cases]);
  useEffect(() => { localStorage.setItem('tcm_notes', JSON.stringify(notes)); }, [notes]);
  useEffect(() => { localStorage.setItem('gemini_api_key', apiKey); }, [apiKey]);
  useEffect(() => {
    if (darkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [darkMode]);
  useEffect(() => {
    if (notification) {
      const timer = setTimeout(() => setNotification(null), 3000);
      return () => clearTimeout(timer);
    }
  }, [notification]);

  // --- 核心功能 ---

  const showNotify = (msg, type = 'success') => {
    setNotification({ msg, type });
  };

  // Gemini API 呼叫函式
  const callGeminiAPI = async (promptType, customQuery = '') => {
    if (!apiKey) {
      showNotify('請先在設定頁面輸入 Gemini API Key', 'error');
      setActiveTab('settings');
      setViewMode('list');
      setModalConfig(null);
      return;
    }

    const item = activeTab === 'notes' ? notes.find(n => n.id === currentId) : cases.find(c => c.id === currentId);
    if (!item) return;

    setAiLoading(true);
    setAiResponse(''); // 清空上次結果

    let systemPrompt = "你是一位專業的中醫師，精通傷寒論、金匱要略與溫病學說。請針對使用者的醫案進行專業分析。使用繁體中文回答。";
    let userPrompt = `以下是一則醫案：\n\n標題：${item.title}\n內文：${item.content}\n\n`;

    if (promptType === 'summary') {
      userPrompt += "請為這則醫案進行摘要，列出：主訴、辨證要點、治法、處方思路。";
    } else if (promptType === 'analysis') {
      userPrompt += "請深入分析這則醫案的脈證邏輯，解釋為什麼醫師會這樣開方？其中蘊含了什麼中醫病機？";
    } else if (promptType === 'custom') {
      userPrompt += `針對這則醫案，我有個問題：${customQuery}`;
    }

    try {
      // 確保 API 呼叫路徑和模型正確
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      
      // 使用 fetch 呼叫 API
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });

      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message);
      }

      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "無法取得回應";
      setAiResponse(text);

    } catch (error) {
      console.error("Gemini API Error:", error);
      setAiResponse(`錯誤：API 呼叫失敗或金鑰無效。請檢查您的金鑰和網路連線。詳情請看控制台 (Console)`);
    } finally {
      setAiLoading(false);
    }
  };

  // 檔案匯入邏輯
  const handleFileSelect = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const content = e.target.result;
      try {
        const json = JSON.parse(content);
        if (Array.isArray(json)) {
          setModalConfig({ type: 'json_confirm', data: json, fileName: file.name });
          return;
        }
      } catch (err) {}
      setPendingFile({ name: file.name, content });
      setSeparatorInput('===');
      setModalConfig({ type: 'import_settings' });
    };
    reader.readAsText(file);
    event.target.value = '';
  };

  const executeTextImport = () => {
    if (!pendingFile) return;
    const { content } = pendingFile;
    const separator = separatorInput.trim();
    let newCases = [];
    let count = 0;

    if (separator) {
       const rawChunks = content.split(separator);
       newCases = rawChunks.map((chunk, index) => {
          const cleanChunk = chunk.trim();
          if (cleanChunk.length === 0) return null;
          const lines = cleanChunk.split('\n');
          let title = lines[0].trim();
          if (title.length > 30) title = title.substring(0, 30) + "...";
          if (title.length === 0) title = `匯入醫案 ${index + 1}`;
          const body = lines.length > 1 ? lines.slice(1).join('\n').trim() : cleanChunk;
          return { id: Date.now() + Math.random().toString(36).substr(2, 9), title: title, content: body || cleanChunk, date: new Date().toISOString().split('T')[0] };
       }).filter(c => c !== null);
       count = newCases.length;
    } else {
       newCases = [{ id: Date.now().toString(), title: pendingFile.name.replace('.txt', ''), content: content, date: new Date().toISOString().split('T')[0] }];
       count = 1;
    }
    if (count > 0) { setCases(prev => [...newCases, ...prev]); showNotify(`成功匯入 ${count} 則醫案`); } 
    else { showNotify('匯入失敗：找不到有效內容', 'error'); }
    setModalConfig(null); setPendingFile(null);
  };

  const executeJsonImport = (data) => {
    setCases(prev => [...prev, ...data]);
    showNotify(`已合併 ${data.length} 筆資料`);
    setModalConfig(null);
  };

  // 搜尋與導航
  const handleSearch = (query, target = 'cases') => {
    setSearchQuery(query);
    if (!query.trim()) { setSearchResults([]); return; }
    const keywords = query.split(/\s+/);
    const sourceData = target === 'notes' ? notes : cases;
    const results = sourceData.filter(c => {
      const text = (c.title + c.content).toLowerCase();
      return keywords.every(k => text.includes(k.toLowerCase()));
    });
    setSearchResults(results);
  };

  const openItem = (id, sourceList, sourceName, mode = 'detail') => {
    setCurrentId(id);
    setNavigationQueue(sourceList.map(c => c.id));
    setContextSource(sourceName);
    setViewMode(mode);
    setIsEditing(false);
  };

  const navigateItem = (direction) => {
    if (isEditing) { setModalConfig({ type: 'confirm_nav', onConfirm: () => { setIsEditing(false); setModalConfig(null); performNav(direction); } }); return; }
    performNav(direction);
  };

  const performNav = (direction) => {
    const currentIndex = navigationQueue.indexOf(currentId);
    if (currentIndex === -1) return;
    let nextIndex = direction === 'next' ? (currentIndex + 1 < navigationQueue.length ? currentIndex + 1 : 0) : (currentIndex - 1 >= 0 ? currentIndex - 1 : navigationQueue.length - 1);
    setCurrentId(navigationQueue[nextIndex]);
  };

  const handleSaveEdit = () => {
    const updater = (prev) => prev.map(c => c.id === currentId ? { ...c, ...editBuffer } : c);
    if (activeTab === 'notes') setNotes(updater); else setCases(updater);
    setIsEditing(false); setModalConfig(null); showNotify('儲存成功');
  };

  const handleDelete = () => {
    setModalConfig({ type: 'confirm_delete', onConfirm: () => {
        if(activeTab==='notes') setNotes(prev => prev.filter(n => n.id !== currentId)); else setCases(prev => prev.filter(c => c.id !== currentId));
        setViewMode('list'); setModalConfig(null); showNotify('已刪除');
    }});
  };

  const createNote = () => {
    const newNote = { id: Date.now().toString(), title: '新筆記', content: '', date: new Date().toISOString().split('T')[0] };
    setNotes([newNote, ...notes]); openItem(newNote.id, [newNote, ...notes], 'notes', 'detail'); setIsEditing(true); setEditBuffer(newNote);
  };

  // --- Render Components ---

  const ModalRenderer = () => {
    if (!modalConfig) return null;
    const ModalBase = ({ title, children, footer }) => (
      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md flex flex-col animate-in fade-in zoom-in duration-200 max-h-[90vh]">
          <div className="p-4 border-b dark:border-slate-700 flex justify-between items-center shrink-0">
            <h3 className="text-lg font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">{title}</h3>
            <button onClick={() => setModalConfig(null)} className="p-1 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-full"><X size={20}/></button>
          </div>
          <div className="p-5 overflow-y-auto">
            {children}
          </div>
          {footer && <div className="p-4 border-t dark:border-slate-700 bg-gray-50 dark:bg-slate-900/50 rounded-b-xl flex justify-end gap-3 shrink-0">{footer}</div>}
        </div>
      </div>
    );

    // AI 助手 Modal
    if (modalConfig.type === 'ai_assistant') {
      return (
        <ModalBase title={<><Sparkles className="text-amber-500"/> AI 醫師助手</>}>
          {!aiResponse ? (
            <div className="space-y-4">
              <p className="text-sm text-gray-500 dark:text-gray-400">請選擇您希望 Gemini 協助分析的內容：</p>
              <div className="grid grid-cols-1 gap-3">
                <button onClick={() => callGeminiAPI('summary')} disabled={aiLoading}
                  className="flex items-center p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-900 rounded-lg hover:bg-amber-100 dark:hover:bg-amber-900/40 text-left">
                  <FileText className="mr-3 text-amber-600" size={20}/>
                  <div>
                    <div className="font-bold text-amber-900 dark:text-amber-100">醫案摘要</div>
                    <div className="text-xs text-amber-700 dark:text-amber-300">快速總結主訴、病機與處方思路</div>
                  </div>
                </button>
                <button onClick={() => callGeminiAPI('analysis')} disabled={aiLoading}
                  className="flex items-center p-4 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-900 rounded-lg hover:bg-emerald-100 dark:hover:bg-emerald-900/40 text-left">
                  <Activity className="mr-3 text-emerald-600" size={20}/>
                  <div>
                    <div className="font-bold text-emerald-900 dark:text-emerald-100">脈證分析</div>
                    <div className="text-xs text-emerald-700 dark:text-emerald-300">深入解析脈象與症狀的關聯</div>
                  </div>
                </button>
                <div className="bg-slate-50 dark:bg-slate-700/30 p-3 rounded-lg border dark:border-slate-600">
                  <div className="flex items-center mb-2">
                    <MessageSquare className="mr-2 text-slate-500" size={18}/>
                    <span className="font-bold text-sm">自由提問</span>
                  </div>
                  <div className="flex gap-2">
                    <input type="text" id="customAiQuery" placeholder="例如：為何這裡不用麻黃？" className="flex-1 p-2 text-sm rounded border dark:bg-slate-800 dark:border-slate-600"/>
                    <button onClick={() => callGeminiAPI('custom', document.getElementById('customAiQuery').value)} disabled={aiLoading} className="bg-slate-800 text-white px-3 rounded text-sm">發問</button>
                  </div>
                </div>
              </div>
              {aiLoading && <div className="text-center text-amber-600 py-4 animate-pulse">正在研讀醫案中...</div>}
            </div>
          ) : (
            <div className="space-y-4">
              <div className="prose dark:prose-invert max-w-none text-sm whitespace-pre-wrap bg-gray-50 dark:bg-slate-900 p-4 rounded-lg border dark:border-slate-700">
                {aiResponse}
              </div>
              <div className="flex gap-2">
                <button onClick={() => setAiResponse('')} className="flex-1 py-2 border rounded hover:bg-gray-100 dark:hover:bg-slate-700">重新提問</button>
                <button onClick={() => {
                    const item = activeTab === 'notes' ? notes.find(n => n.id === currentId) : cases.find(c => c.id === currentId);
                    const noteText = `\n\n=== AI 分析紀錄 ===\n${aiResponse}`;
                    if (activeTab === 'notes') {
                       setNotes(prev => prev.map(n => n.id === currentId ? {...n, content: n.content + noteText} : n));
                    } else {
                       // 若在醫案頁面，新增一則筆記
                       const newNote = { id: Date.now().toString(), title: `AI筆記: ${item.title}`, content: aiResponse, date: new Date().toISOString().split('T')[0] };
                       setNotes(prev => [newNote, ...prev]);
                       showNotify("已存入筆記本");
                    }
                    setModalConfig(null);
                }} className="flex-1 py-2 bg-amber-600 text-white rounded hover:bg-amber-700">存入筆記</button>
              </div>
            </div>
          )}
        </ModalBase>
      );
    }

    // 其他 Modals (Import, Confirm Delete etc.) - 簡化重用 V3 邏輯
    if (modalConfig.type === 'import_settings') {
      return ( <ModalBase title="匯入文字檔設定" footer={<><button onClick={()=>setModalConfig(null)} className="px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-slate-700">取消</button><button onClick={executeTextImport} className="px-4 py-2 bg-amber-600 text-white rounded">開始匯入</button></>}><div className="space-y-4"><div className="text-sm">檔案：{pendingFile?.name}</div><div className="bg-amber-50 dark:bg-amber-900/20 p-4 rounded"><label className="block text-sm font-bold mb-2">醫案分隔符號</label><input value={separatorInput} onChange={e=>setSeparatorInput(e.target.value)} className="w-full p-2 border rounded text-center dark:bg-slate-900 dark:border-slate-700"/><p className="text-xs text-gray-500 mt-2">單一醫案請留空。</p></div></div></ModalBase> );
    }
    if (modalConfig.type === 'json_confirm') { return ( <ModalBase title="偵測到備份檔" footer={<><button onClick={()=>setModalConfig(null)} className="px-4 py-2">取消</button><button onClick={()=>executeJsonImport(modalConfig.data)} className="px-4 py-2 bg-emerald-600 text-white rounded">合併匯入</button></>}><p>包含 {modalConfig.data.length} 筆資料，確定合併？</p></ModalBase> ); }
    if (modalConfig.type === 'confirm_delete') { return ( <ModalBase title="確認刪除" footer={<><button onClick={()=>setModalConfig(null)} className="px-4 py-2 bg-gray-200 dark:bg-slate-700 rounded">取消</button><button onClick={modalConfig.onConfirm} className="px-4 py-2 bg-red-600 text-white rounded">確認刪除</button></>}><p className="text-red-500">此操作無法復原。</p></ModalBase> ); }
    if (modalConfig.type === 'confirm_save') { return ( <ModalBase title="儲存變更" footer={<><button onClick={()=>setModalConfig(null)} className="px-4 py-2 rounded bg-gray-200 dark:bg-slate-700">再編輯一下</button><button onClick={handleSaveEdit} className="px-4 py-2 bg-amber-600 text-white rounded">確認儲存</button></>}><p>確定要儲存目前的修改嗎？</p></ModalBase> ); }

    return null;
  };

  const DetailView = () => {
    const list = activeTab === 'notes' ? notes : cases;
    const item = list.find(c => c.id === currentId);
    if (!item) return <div>資料不存在</div>;

    return (
      <div className="flex flex-col h-full bg-white dark:bg-slate-900 text-slate-900 dark:text-slate-100">
        <div className="flex items-center justify-between p-3 border-b dark:border-slate-700 bg-amber-50 dark:bg-slate-800">
          <button onClick={() => setViewMode('list')} className="p-2 rounded-full hover:bg-black/10 flex items-center">
            <ChevronLeft size={20}/>
          </button>
          <div className="flex gap-2">
            {!isEditing && (
               <>
                <button onClick={() => setModalConfig({ type: 'ai_assistant' })} className="flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-full text-sm font-bold shadow hover:shadow-md transition-all">
                  <Sparkles size={16}/> AI 分析
                </button>
                <button onClick={() => { navigator.clipboard.writeText(item.content); showNotify('已複製'); }} className="p-2 hover:bg-black/10 rounded-full"><Copy size={20}/></button>
                <button onClick={() => { setEditBuffer(item); setIsEditing(true); }} className="p-2 hover:bg-black/10 rounded-full"><Edit3 size={20}/></button>
                <button onClick={handleDelete} className="p-2 text-red-500 hover:bg-red-100 rounded-full"><Trash2 size={20}/></button>
               </>
            )}
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-4" style={{ fontSize: `${fontSize}px` }}>
          {isEditing ? (
            <div className="flex flex-col gap-3 h-full">
               <input value={editBuffer.title} onChange={e => setEditBuffer({...editBuffer, title: e.target.value})} className="text-xl font-bold p-2 border rounded dark:bg-slate-800 dark:border-slate-600"/>
               <textarea value={editBuffer.content} onChange={e => setEditBuffer({...editBuffer, content: e.target.value})} className="flex-1 p-2 border rounded resize-none dark:bg-slate-800 dark:border-slate-600 font-mono leading-relaxed"/>
               <div className="flex justify-end gap-3 pb-2">
                  <button onClick={() => setIsEditing(false)} className="px-4 py-2 rounded bg-gray-200 dark:bg-slate-700">取消</button>
                  <button onClick={() => setModalConfig({ type: 'confirm_save' })} className="px-4 py-2 rounded bg-amber-600 text-white font-bold">儲存</button>
               </div>
            </div>
          ) : (
            <>
              <h2 className="text-2xl font-bold mb-2 text-amber-800 dark:text-amber-400 select-text">{item.title}</h2>
              <p className="text-xs text-gray-400 mb-4 border-b pb-2 select-none">{item.date}</p>
              <div className="whitespace-pre-wrap leading-relaxed select-text">{item.content}</div>
            </>
          )}
        </div>
        {!isEditing && (
          <div className="p-3 border-t dark:border-slate-700 flex justify-between bg-gray-50 dark:bg-slate-800 select-none">
            <button onClick={() => navigateItem('prev')} className="flex items-center px-4 py-3 bg-white dark:bg-slate-700 rounded shadow text-sm active:scale-95 transition-transform"><ChevronLeft size={16}/> 上一則</button>
            <div className="text-xs self-center opacity-50">{navigationQueue.indexOf(currentId)+1} / {navigationQueue.length}</div>
            <button onClick={() => navigateItem('next')} className="flex items-center px-4 py-3 bg-white dark:bg-slate-700 rounded shadow text-sm active:scale-95 transition-transform">下一則 <ChevronRight size={16}/></button>
          </div>
        )}
      </div>
    );
  };

  const ListRenderer = ({ data, type }) => (
    <div className="p-4 space-y-3 pb-24">
      {data.length === 0 && <div className="text-center text-gray-400 mt-10">暫無資料</div>}
      {data.map(item => (
        <div key={item.id} onClick={() => openItem(item.id, data, type)} className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border-l-4 border-transparent hover:border-amber-500 cursor-pointer active:bg-gray-50 dark:active:bg-slate-700">
          <div className="font-bold text-lg text-slate-800 dark:text-slate-200 truncate">{item.title}</div>
          <div className="text-gray-500 text-sm line-clamp-2 mt-1">{item.content}</div>
        </div>
      ))}
    </div>
  );

  return (
    <div className={`flex flex-col h-screen w-full font-sans ${darkMode ? 'dark' : ''} bg-gray-100 dark:bg-slate-950 text-slate-900 dark:text-slate-100 overflow-hidden`}>
      {notification && ( <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[110] px-6 py-3 rounded-full shadow-lg text-white text-sm font-bold flex items-center animate-in slide-in-from-top-5 fade-in duration-300 ${notification.type === 'error' ? 'bg-red-500' : 'bg-emerald-600'}`}> {notification.type === 'success' ? <Check size={18} className="mr-2"/> : <AlertCircle size={18} className="mr-2"/>} {notification.msg} </div> )}
      <ModalRenderer />
      {viewMode === 'detail' ? <DetailView /> : (
        <div className="flex-1 overflow-hidden flex flex-col relative">
          {activeTab === 'cases' && <div className="p-4 bg-amber-600 text-white font-bold shadow select-none">醫案資料庫 ({cases.length})</div>}
          {activeTab === 'notes' && <div className="p-4 bg-emerald-600 text-white font-bold shadow flex justify-between items-center select-none"><span>我的筆記 ({notes.length})</span><button onClick={createNote} className="bg-white/20 p-1 rounded hover:bg-white/30"><Plus size={20}/></button></div>}
          {activeTab === 'search' && <div className="p-3 bg-white dark:bg-slate-800 shadow z-10"><div className="relative"><Search className="absolute left-3 top-2.5 text-gray-400" size={18}/><input type="text" placeholder="輸入關鍵字..." value={searchQuery} onChange={(e) => handleSearch(e.target.value, activeTab === 'notes' ? 'notes' : 'cases')} className="w-full pl-10 pr-4 py-2 rounded border bg-gray-50 dark:bg-slate-700 dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-amber-500"/></div></div>}
          
          <div className="flex-1 overflow-y-auto scroll-smooth">
             {activeTab === 'random' && ( <div className="h-full flex flex-col items-center justify-center p-8 select-none"><Shuffle size={64} className="text-amber-500 mb-6"/><button onClick={() => { if(cases.length===0) return showNotify('無資料', 'error'); const rnd = cases[Math.floor(Math.random()*cases.length)]; openItem(rnd.id, cases, 'random'); }} className="px-8 py-3 bg-amber-600 text-white rounded-lg text-xl shadow-lg active:scale-95 transition-transform">隨機抽一則</button></div> )}
             {activeTab === 'cases' && <ListRenderer data={cases} type="database" />}
             {activeTab === 'notes' && <ListRenderer data={notes} type="notes" />}
             {activeTab === 'search' && <ListRenderer data={searchResults} type="search" />}
             {activeTab === 'settings' && (
                <div className="p-6 space-y-6 select-none pb-24">
                  <h2 className="text-xl font-bold border-b pb-2 dark:border-slate-700">設定</h2>
                  {/* API Key 設定區塊 */}
                  <div className="bg-gradient-to-r from-slate-800 to-slate-900 p-4 rounded-lg text-white shadow-lg">
                    <div className="flex items-center mb-2 gap-2">
                      <Key size={20} className="text-amber-400"/>
                      <span className="font-bold">Gemini API 設定</span>
                    </div>
                    <p className="text-xs text-slate-300 mb-3">輸入 API Key 以啟用 AI 醫案分析功能。</p>
                    <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="貼上您的 API Key" className="w-full p-2 rounded bg-slate-700 border border-slate-600 text-white focus:border-amber-500 focus:outline-none text-sm"/>
                    <div className="text-[10px] text-slate-400 mt-2 text-right">金鑰僅儲存於您的裝置中</div>
                  </div>
                  <div className="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm"><div className="flex justify-between items-center mb-4"><span>深色模式</span><button onClick={() => setDarkMode(!darkMode)} className={`w-10 h-5 rounded-full relative ${darkMode?'bg-amber-600':'bg-gray-300'}`}><span className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${darkMode?'left-6':'left-1'}`}/></button></div><div><div className="flex justify-between text-sm mb-1"><span>字體大小</span><span>{fontSize}px</span></div><input type="range" min="14" max="30" value={fontSize} onChange={e=>setFontSize(Number(e.target.value))} className="w-full accent-amber-600"/></div></div>
                  <div className="bg-white dark:bg-slate-800 p-4 rounded-lg space-y-3 shadow-sm"><div onClick={() => fileInputRef.current.click()} className="block w-full p-3 border-2 border-dashed border-amber-300 rounded-lg text-center cursor-pointer hover:bg-amber-50 dark:hover:bg-slate-700/50 transition-colors"><Upload className="mx-auto mb-1 text-amber-600"/><span className="font-bold text-amber-700 dark:text-amber-400">匯入醫案 (TXT/JSON)</span><div className="text-xs text-gray-500 mt-1">支援批次切割</div><input ref={fileInputRef} type="file" accept=".txt,.json" className="hidden" onChange={handleFileSelect} /></div><button onClick={() => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cases)); const a = document.createElement('a'); a.href = dataStr; a.download = "medical_cases_backup.json"; a.click(); showNotify('已下載備份檔'); }} className="w-full py-3 bg-gray-100 dark:bg-slate-700 rounded flex justify-center items-center hover:bg-gray-200 dark:hover:bg-slate-600"><Download size={18} className="mr-2"/> 備份醫案資料庫</button></div>
                </div>
             )}
          </div>
        </div>
      )}
      <div className="bg-white dark:bg-slate-900 border-t dark:border-slate-800 h-16 flex justify-around items-center shrink-0 z-50 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] select-none">
        {[{ id: 'random', icon: Shuffle, label: '隨機' }, { id: 'cases', icon: BookOpen, label: '醫案' }, { id: 'search', icon: Search, label: '搜尋' }, { id: 'notes', icon: FileText, label: '筆記' }, { id: 'settings', icon: Settings, label: '設定' }].map(tab => ( <button key={tab.id} onClick={() => { setActiveTab(tab.id); setViewMode('list'); }} className={`flex flex-col items-center justify-center w-full h-full ${activeTab===tab.id ? 'text-amber-600 dark:text-amber-400' : 'text-gray-400'}`}><tab.icon size={24} strokeWidth={activeTab===tab.id?2.5:2}/><span className="text-[10px] font-medium mt-1">{tab.label}</span></button> ))}
      </div>
    </div>
  );
}
const rootElement = document.getElementById('root');
window.onload = function() {
  try {
    ReactDOM.createRoot(rootElement).render(<App />);
  } catch (e) {
    console.error("Failed to initialize React App:", e);
    rootElement.innerHTML = `<div style="padding: 20px; color: red;">應用程式初始化失敗。請確認您的網路連線是否正常，並查看瀏覽器的控制台(F12)獲取詳細錯誤訊息。</div>`;
  }
};
  </script>
</body>
</html>
